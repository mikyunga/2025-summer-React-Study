<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <button id="request">요청 보내기</button>
    <p id="response"></p>
    <small id="user"></small>
    <script>
      const requestBtn = document.getElementById('request');
      const responseText = document.getElementById('response');
      const userText = document.getElementById('user');

      const getTodo = (resolve, reject) => {
        const xhr = new XMLHttpRequest();

        xhr.open('GET', 'https://jsonplaceholder.typicode.com/todos/1');
        // xhr.setRequestHeader("", "")
        // xhr.setRequestHeader("", "")
        // xhr.setRequestHeader("", "")
        // xhr.setRequestHeader("", "")

        xhr.send(); // 3-1

        xhr.onreadystatechange = () => {
          if (xhr.readyState !== XMLHttpRequest.DONE) return;

          if (xhr.status === 200) {
            console.log(JSON.parse(xhr.response));
            // 직렬화/역직렬화의 이유: 다른 컴퓨터로의 데이터 전송시에는 무조건 '텍스트' 형태로 전송해야 하기 때문
            // 여기서 문제는 자바스크립트 코드 내에서는 객체 형태로 사용되어야 한다.
            // 직렬화: 나중에 자바스크립트 객체로 변환하기 편한 형태로 객체를 텍스트화 시키는 것
            // 직렬화의 요건 1. 객체를 문자열로 변환 / 2. 나중에 역직렬화할 수 있는 규칙으로 변환
            // 역직렬화: 직렬화된 텍스트를 자바스크립트 객체 형태로 변환하는 것
            console.log(JSON.stringify({ name: 'Jungmin' })); // 직렬화
            console.log(JSON.parse('{"name":"Jungmin"}')); // 역직렬화

            const todoData = JSON.parse(xhr.response);

            resolve(todoData);
          }
        };

        xhr.onerror = () => {
          reject('fetch 오류');
        };
      };

      const getUser = (todoData) => {
        const userXhr = new XMLHttpRequest();

        userXhr.open(
          'GET',
          `https://jsonplaceholder.typicode.com/users/${todoData.userId}`
        );

        userXhr.send();

        userXhr.onreadystatechange = () => {
          if (userXhr.readyState !== XMLHttpRequest.DONE) return;
          if (userXhr.status === 200) {
            const userData = JSON.parse(userXhr.response);
            userText.innerText = userData.name;
          }
        };
      };

      requestBtn.addEventListener('click', async () => {
        // resolve랑 reject를 통해 넘겨..줌
        // resolve면 후속작업(then) 실행
        // new Promise((resolve, reject) => {
        //   getTodo(resolve, reject);
        // })
        //   .then((todoData) => {
        //     // todoData를 받아서 innerText를 보여줌
        //     responseText.innerText = todoData.title;
        //     // 인수로 받은 todoData를 return해줘야 다음 then에서 쓸 수 있음
        //     return todoData;
        //   })
        //   .then((todoData) => {
        //     // todoData를 받아서 user정보 get해옴
        //     getUser(todoData);
        //   })
        //   .catch((message) => {
        //     console.error(message);
        //   });

        // fetch('https://jsonplaceholder.typicode.com/todos/1', {
        //   method: 'GET',
        // })
        //   // 역직렬화는 해줘야함
        //   .then((result) => result.json())
        //   .then((todoData) => {
        //     console.log(todoData);
        //     responseText.innerText = todoData.title;
        //     return todoData;
        //   })
        //   .then((todoData) => {
        //     return fetch(
        //       `https://jsonplaceholder.typicode.com/users/${todoData.userId}`
        //     );
        //   })
        //   .then((result) => result.json())
        //   .then((userData) => {
        //     userText.innerText = userData.name;
        //   });

        const response = await fetch(
          'https://jsonplaceholder.typicode.com/todos/1',
          {
            method: 'GET',
          }
        );
        // resolve되는 값을 then이아니라 값으로 바로 받을 수 있음!

        const todoData = await response.json();

        console.log(todoData);
        responseText.innterText = todoData.title;

        const userResponse = await fetch(
          `https://jsonplaceholder.typicode.com/users/${todoData.userId}`
        );

        const userData = await userResponse.json();

        userText.innerText = userData.name;
      });
    </script>
  </body>
</html>
